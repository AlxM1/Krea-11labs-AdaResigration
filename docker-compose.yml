services:
  # Next.js Web Application
  # Connects to shared postgres + redis from parent compose
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: krya-web
    restart: unless-stopped
    ports:
      - "3100:3000"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=krya
      - DB_PASSWORD=${KRYA_DB_PASSWORD:-krya_dev_password}
      - DB_NAME=krya
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=1
      - WS_PORT=3001
      - UPLOAD_DIR=/app/uploads
    volumes:
      - /mnt/data/00raiser/media/krya:/app/uploads
    networks:
      - raiser-net

  # Database migrations (run once)
  migrate:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      target: builder
    container_name: krya-migrate
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=krya
      - DB_PASSWORD=${KRYA_DB_PASSWORD:-krya_dev_password}
      - DB_NAME=krya
    command: npx prisma migrate deploy --config prisma/prisma.config.ts
    networks:
      - raiser-net

networks:
  raiser-net:
    external: true
